var connection = require("Conexion");

module.exports = NuevoComentario;

function NuevoComentario(partida, usuario, comentario, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {
        if (!err) {
            var sql = "select ID from partidas where partidas.Nombre = '" + partida + "';";

            conexion.query(sql, function (err, resultado) {
                if (!err) {
                    var IDPartida = resultado[0].ID;
                    sql = "select ID from usuario where usuario.Nombre_Usuario = '" + usuario + "';";

                    conexion.query(sql, function () {
                        if (!err) {
                            var IDUsuario = resultado[0].ID;
                            sql = "insert into comentarios " +
                                    "(`ID`, `ID_Partida`, `ID_Usuario`, `Texto`, `Fecha`) " +
                                    "VALUES (null, '" + IDPartida + "', '" + IDUsuario + "', '" + comentario + "', '" + new Date() + "');";

                            conexion.query(sql, function () {
                                if (!err) {
                                    callback(null, resultado);
                                } else {
                                    callback(err);
                                }
                            });
                        } else {
                            callback(err);
                        }
                    });

                } else {
                    callback(err);
                }
            });
        } else {
            callback(err);
        }
    });
}