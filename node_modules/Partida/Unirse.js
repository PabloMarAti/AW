var connection = require("Conexion");


module.exports = Unirse;

function Unirse(partida, usuario, maximo, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }
    conexion.connect(function (err) {
        if (err) {
            callback(err);
        } else {
            var sql = "select partidas.ID as id from partidas where partidas.Nombre = ?;";

            conexion.query(sql, [partida], function (err, filas) {

                if (!err) {
                    var id = filas[0].id;
                    sql = "INSERT INTO `juega` (`ID_Usuario`, `ID_Partida`) " +
                          "select usuario.ID, partidas.ID from usuario, partidas " +
                          "where usuario.Nombre_Usuario = ? and partidas.Nombre = ?;";
                    conexion.query(sql, [usuario, partida], function (err) {
                        if (!err) {
                            sql = "select COUNT(juega.ID_Usuario) as num from juega where juega.ID_Partida = ? group by juega.ID_Partida;";

                            conexion.query(sql, [id], function (err, resultado) {

                                if (!err) {
                                    if (resultado[0].num === parseInt(maximo)) {
                                        callback(null, false);//La partida se ha llenado y se llama a cerrar partida
                                    } else {
                                        callback(null, true);//te has unido con exito
                                    }
                                } else {
                                    callback(err);
                                }
                                conexion.end();
                            });
                        } else {
                            callback(err);
                        }
                    });
                } else {
                    callback(err);
                }
            });
        }
    });
}