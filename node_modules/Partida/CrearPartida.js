var connection = require("Conexion");

module.exports = CrearPartida;

function CrearPartida(nombre, creador, numeroJugadores, callback) {

    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }
    conexion.connect(function (err) {
        if (err) {
            callback(err);
        } else {
            var sql = "select Nombre " +
                    "from partidas " +
                    "where partidas.Nombre = '" + nombre + "';";
            conexion.query(sql, function (err, filas) {
                if (err) {
                    callback(err);
                } else {
                    if (filas.length !== 0) {
                        callback(null, "Ya existe la partida: " + nombre);
                    } else {
                        var today = new Date();
                        var dd = today.getDate();
                        var mm = today.getMonth() + 1;
                        var yyyy = today.getFullYear();
                        
                        if(dd < 10){
                            dd = '0' + dd;
                        }
                        
                        if(mm < 10){
                            mm = '0' + mm;
                        }
                        
                        today = dd + '/' + mm + '/' + yyyy;
                        
                        var turnos = 0;
                        switch (numeroJugadores) {
                            case "3":
                                turnos = 50;
                                break;
                            case "4":
                                turnos = 45;
                                break;
                            case "5":
                                turnos = 40;
                                break;
                            case "6":
                                turnos = 40;
                                break;
                            case "7":
                                turnos = 35;
                                break;
                        }
                        sql = "INSERT INTO `partidas` (`ID`, `Nombre`, `Creador`, `Fecha`, `Estado`, `Numero_Jugadores`, `Turnos_restantes`)" +
                                " VALUES (NULL, '" + nombre + "', '" + creador + "', '" + today + "', 'Abierta', '" + numeroJugadores + "', '" + turnos + "');";
                        conexion.query(sql, function (err) {
                            if (!err) {
                                var sql1 = "INSERT INTO `juega` (`ID_Usuario`, `ID_Partida`) " + 
                                      "select usuario.ID, partidas.ID from usuario, partidas " + 
                                      "where usuario.Nombre_Usuario = '" + creador + "' and partidas.Nombre = '" + nombre + "';";
                                conexion.query(sql1, function (err){
                                    if(!err){
                                        callback(null);
                                    } else{
                                        callback(err);
                                    }
                                });
                            } else {    
                                callback(err);
                            }
                        });
                    }
                }
                conexion.end();
            });
        }
    });
}