var connection = require("Conexion");
var game = require("../Partida/LeerPartidas.js");

module.exports = CambiarTurno;

function CambiarTurno(partida, numeroCambiosTurno, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {
        if (!err) {
            game.PartidaActual(partida, function (err, PartidaActual) {
                if (!err) {
                    var busqueda = PartidaActual[0].Turno;
                    var indice = -1;
                    for (var i = 0, len = PartidaActual.length; i < len; i++) {
                        if (PartidaActual[i].Nombre_Usuario === busqueda) {
                            indice = i;
                            break;
                        }
                    }
                    if (indice === len - 1) {
                        indice = 0;
                    } else {
                        indice++;
                    }

                    var sql = "update partidas " +
                            "set Turno = ?, Turnos_restantes = ? " +
                            "where partidas.Nombre = ?;";

                    conexion.query(sql, [PartidaActual[indice].Nombre_Usuario, (PartidaActual[0].Turnos_restantes - 1), partida], function (err) {
                        if (!err) {
                            if (PartidaActual[indice].Pico !== 0 && numeroCambiosTurno !== PartidaActual.length && (PartidaActual[0].Turnos_restantes - 1) !== 0) {
                                CambiarTurno(partida, (numeroCambiosTurno + 1), function (err, ganador) {
                                    if (!err) {
                                        callback(null, ganador);
                                    } else {
                                        callback(err);
                                    }
                                    conexion.end();
                                });
                            } else if (numeroCambiosTurno === PartidaActual.length || (PartidaActual[0].Turnos_restantes - 1) === 0) {
                                callback(null, true);
                            } else {
                                callback(null, false);
                                conexion.end();
                            }
                        } else {
                            callback(err);
                        }
                    });
                } else {
                    callback(err);
                }
            });
        } else {
            callback(err);
        }
    });
}