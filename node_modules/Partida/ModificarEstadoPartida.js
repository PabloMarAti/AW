var connection = require("Conexion");

module.exports = {
    ActivarPartida: ActivarPartida,
    CerrarPartida: CerrarPartida
};

//Activa una partida, ya sea porque esta llena o porque el creador lo ha solicitado
function ActivarPartida(partida, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {

        if (!err) {
            var sql = "select partidas.ID as id from partidas where partidas.Nombre = ?;";

            conexion.query(sql, [partida], function (err, IDPartida) {
                if (!err) {
                    var id = IDPartida[0].id;
                    sql = "select COUNT(juega.ID_Usuario) as num from juega where juega.ID_Partida = ? group by juega.ID_Partida;";

                    conexion.query(sql, [id], function (err, filas) {
                        if (!err) {
                            var usuarios = filas[0].num;
                            if (usuarios >= 3) {
                                ModificarEstadoPartida(id, "Activa", function (err, resultado) {
                                    if (!err) {
                                        callback(null, true);
                                    } else {
                                        callback(err);
                                    }
                                });
                            } else {
                                callback(null, false);
                            }
                        } else {
                            callback(err);
                        }
                        conexion.end();
                    });
                } else {

                }
            });
        } else {
            callback(err);
        }
    });
}

//Cierra una partida, ya sea porque esta llena o porque el creador lo ha solicitado
function CerrarPartida(partida, ganador, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {

        if (!err) {
            var sql = "select partidas.ID as id from partidas where partidas.Nombre = ?;";

            conexion.query(sql, [partida], function (err, IDPartida) {
                if (!err) {
                    var id = IDPartida[0].id;
                    sql = "update partidas " +
                            "set Ganador = ? " +
                            "where ID = ?;";
                    conexion.query(sql, [ganador, id], function (err, resultado) {
                        if (!err) {
                            ModificarEstadoPartida(id, "Cerrada", function (err, resultado) {
                                if (!err) {
                                    callback(null, true);
                                } else {
                                    callback(err);
                                }
                            });
                        } else {
                            callback(err);
                        }
                        conexion.end();
                    });
                } else {
                    callback(err);
                }
            });
        } else {
            callback(err);
        }
    });
}

//Modifica el estado de la partida con IDPartida con el estado que se le pasa como parametro
function ModificarEstadoPartida(IDPartida, estado, callback) {
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {
        if (!err) {
            sql = "UPDATE `partidas` SET Estado = ? " +
                    "WHERE partidas.ID = ?;";
            conexion.query(sql, [estado, IDPartida], function (err, filas) {
                if (!err) {
                    callback(null, filas);
                } else {
                    callback(err);
                }
                conexion.end();
            });
        } else {
            callback(null, false);
        }
    });
}