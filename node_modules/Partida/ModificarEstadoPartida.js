var connection = require("Conexion");

module.exports = ModificarEstadoPartida;

var rolturno = require("./RolTurno.js");

function ModificarEstadoPartida(partida, estado, callback){
    var conexion = connection.getConexion();
    if (callback === undefined) {
        callback = function () {};
    }

    conexion.connect(function (err) {

        if (err) {
            callback(err);
        } else {

            var sql = "select partidas.ID as id from partidas where partidas.Nombre = '" + partida + "';";

            conexion.query(sql, function (err, filas) {
                if (!err) {
                    var id = filas[0].id;
                    sql = "select COUNT(juega.ID_Usuario) as num from juega where juega.ID_Partida = '" + id + "' group by juega.ID_Partida;";

                    conexion.query(sql, function (err, filas) {
                        if (!err) {
                            var usuarios = filas[0].num;
                            if (usuarios >= 3) {
                                sql = "UPDATE `partidas` SET Estado = '" + estado +
                                        "' WHERE partidas.ID = '" + id + "';";
                                conexion.query(sql, function (err) {
                                    if (!err) {
                                        rolturno(id, usuarios, function(err, resultado){
                                            if(!err){
                                                console.log("Partida Cerrada");
                                                callback(null, resultado);
                                            } else{
                                                callback(err);
                                            }
                                        });
                                    } else {
                                        console.log(err);
                                        callback(err);
                                    }
                                    conexion.end();
                                });
                            } else {
                                console.log("NO hay jugadores para cerrar partida");
                            }
                        } else {
                            callback(err);
                        }
                    });
                } else{
                    
                }
            });
        }
    });
}