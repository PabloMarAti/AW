var connection = require("Conexion");
var game = require("../Partida/LeerPartidas.js");

module.exports = InicializarCartas;

// esta funcion reparte las cartas a los usuarios de una partida que se ha cerrado
function InicializarCartas (partida, callback) {

    if (callback === undefined) {
        callback = function () {};
    }

//Primero leemos los datos de la partida actual(Numero de jugadores de la partida)
    game.PartidaActual(partida, function (err, partidaJugada) {
        if (!err) {
//Construimos la sql para las cartas 
            var sql = "INSERT INTO `Tiene` (`ID`, `ID_Usuario`, `ID_Partida`, `ID_Carta`) VALUES";
            for (x = 0; x < partidaJugada.length; x++) {
                for (y = 0; y < 7; y++) {
                    sql = sql + " (NULL, '" + partidaJugada[x].user + "', '" + partidaJugada[x].game + "', '" + Math.floor((Math.random() * 19) + 5) + "')";
                    if (x !== partidaJugada.length - 1 || y !== 6) {
                        sql = sql + ", ";
                    }
                }
            }
            var conexion = connection.getConexion();
            conexion.connect(function (err) {
                if (!err) {
                    conexion.query(sql, function (err) {
                        if (err) {
                            callback(err);
                        } else {
                            callback(null, true);
                        }
                        conexion.end();
                    });
                } else{
                    callback(err);
                }
            });
        } else {
            callback(err);
        }
    });
}